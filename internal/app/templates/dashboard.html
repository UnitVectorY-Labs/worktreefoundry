<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>worktreefoundry</title>
  <link rel="stylesheet" href="/static/app.css">
  <script src="/static/htmx.min.js"></script>
</head>
<body>
<header>
  <strong>worktreefoundry</strong>
  <span class="muted">repo: {{.RepoRoot}}</span>
</header>
<main>
  {{if .Flash}}
  <div class="panel {{if .FlashError}}error{{else}}ok{{end}}">{{.Flash}}</div>
  {{end}}

  <div class="row">
    <div class="col">
      <section class="panel">
        <h2>Workspaces</h2>
        <p class="muted">Main is read-only. Edit using a workspace branch.</p>
        <form method="get" action="/">
          <label>Active workspace</label>
          <select name="ws" onchange="this.form.submit()">
            <option value="main" {{if eq .CurrentWorkspace "main"}}selected{{end}}>main (read-only)</option>
            {{range .Workspaces}}
            <option value="{{.Name}}" {{if eq $.CurrentWorkspace .Name}}selected{{end}}>{{.Name}}{{if .Dirty}} *dirty{{end}}</option>
            {{end}}
          </select>
        </form>

        <form method="post" action="/workspaces" style="margin-top: 1rem;">
          <label>Create workspace</label>
          <input type="text" name="name" placeholder="feature-xyz" required>
          <button class="primary" type="submit">Create</button>
        </form>

        {{if ne .CurrentWorkspace "main"}}
        <form method="post" action="/workspaces/save" style="margin-top: 1rem;">
          <input type="hidden" name="ws" value="{{.CurrentWorkspace}}">
          <label>Save message</label>
          <input type="text" name="message" placeholder="Save workspace changes">
          <button class="primary" type="submit">Save (commit)</button>
        </form>

        <form method="post" action="/workspaces/merge" style="margin-top: 0.75rem;">
          <input type="hidden" name="ws" value="{{.CurrentWorkspace}}">
          <button class="primary" type="submit">Merge Into Main</button>
        </form>

        <form method="post" action="/workspaces/delete" style="margin-top: 0.75rem;">
          <input type="hidden" name="ws" value="{{.CurrentWorkspace}}">
          <button class="danger" type="submit">Delete Workspace</button>
        </form>
        {{end}}
      </section>

      <section class="panel">
        <h3>Validation</h3>
        <form method="post" action="/validate">
          <input type="hidden" name="ws" value="{{.CurrentWorkspace}}">
          <button type="submit">Run Validation</button>
        </form>
        {{if .ValidationRan}}
          {{if .ValidationOK}}
            <p class="ok">Validation passed.</p>
          {{else}}
            <p class="error">Validation failed.</p>
            <ul>
              {{range .ValidationIssues}}
                <li><span class="code">[{{.Stage}}]</span> {{.Path}} {{if .Field}}(<span class="code">{{.Field}}</span>){{end}}: {{.Message}}</li>
              {{end}}
            </ul>
          {{end}}
        {{end}}
      </section>
    </div>

    <div class="col">
      <section class="panel">
        <h2>Types And Objects</h2>
        {{if .Types}}
          {{range .Types}}
          {{$typeName := .Name}}
          <div style="margin-bottom: 1rem;">
            <h3 style="margin-bottom: 0.3rem;">{{$typeName}}</h3>
            <p>
              <a href="/object/new?ws={{$.CurrentWorkspace}}&type={{$typeName}}">Create object</a>
            </p>
            {{if .Objects}}
            <ul>
              {{range .Objects}}
                <li><a href="/object?ws={{$.CurrentWorkspace}}&type={{$typeName}}&id={{.ID}}">{{.ID}}</a></li>
              {{end}}
            </ul>
            {{else}}
            <p class="muted">No objects.</p>
            {{end}}
          </div>
          {{end}}
        {{else}}
        <p class="muted">No schema types found.</p>
        {{end}}
      </section>

      {{if and (ne .CurrentWorkspace "main") .WorkspaceDirtyFiles}}
      <section class="panel">
        <h3>Dirty Files</h3>
        <ul>
          {{range .WorkspaceDirtyFiles}}
            <li><span class="code">{{.}}</span></li>
          {{end}}
        </ul>
      </section>
      {{end}}
    </div>
  </div>
</main>
</body>
</html>
